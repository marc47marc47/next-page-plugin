# Anime Next 導航策略總覽

## 概述

Anime Next 擴充功能採用**三層智能導航策略**，確保在各種網站上都能實現鍵盤分頁導航功能。每一層都是前一層的備用方案，提供最大的相容性和可靠性。

## 三層導航策略

```
🎯 第 1 層：按鈕導航（Button Navigation）
   ↓ 找不到按鈕時
🔄 第 2 層：URL 參數導航（URL Parameter Navigation）
   ↓ URL 中沒有頁碼參數時
🔍 第 3 層：智能連結掃描（Href Link Scanning）
```

---

## 第 1 層：按鈕導航

### 描述
尋找並點擊頁面上實際的分頁按鈕元素。

### 優先級
⭐⭐⭐ 最高（首選方案）

### 工作原理

1. **按 ID 查找**：優先使用預設或自訂的按鈕 ID
2. **按 Class 查找**：使用常見的分頁按鈕 class 名稱
3. **按屬性查找**：使用 data 屬性或其他識別特徵

### 支援的選擇器

```javascript
// 預設 ID
- table-list_next
- table-list_previous

// 預設 Class
- paginate_button.next
- paginate_button.previous

// Data 屬性
- [data-dt-idx="next"]
- [data-dt-idx="previous"]

// 自訂 ID
- 用戶在設定中配置的 ID
```

### 優點

- ✅ **最可靠**：直接觸發網站原生的分頁邏輯
- ✅ **最快速**：無需額外計算或解析
- ✅ **最準確**：遵循網站的分頁規則（包括權限檢查等）
- ✅ **支援複雜邏輯**：適用於 AJAX 分頁、無限滾動等

### 限制

- ❌ 需要頁面有實際的按鈕元素
- ❌ 需要正確配置按鈕 ID 或 class
- ❌ 按鈕被隱藏或禁用時無法使用

### 適用網站

- DataTables 表格
- Bootstrap 分頁
- jQuery UI 分頁
- 任何使用標準按鈕的網站

### 配置方法

1. 開啟擴充功能設定
2. 在「自訂按鈕 ID」區域添加按鈕的 ID
3. 每行一個 ID，支援多個 ID

### 測試頁面

- `test/test-page.html` - 標準按鈕測試
- `test/custom-id-test.html` - 自訂 ID 測試

### 相關文件

- [自訂 ID 指南](CUSTOM-ID-GUIDE.md)

---

## 第 2 層：URL 參數導航

### 描述
通過修改 URL 中的頁碼參數來實現導航。

### 優先級
⭐⭐ 中等（第一備用方案）

### 工作原理

1. **讀取當前頁碼**：從 URL 的查詢參數中提取 `page=N`
2. **計算目標頁碼**：當前頁 ±1
3. **構建新 URL**：修改 page 參數為目標頁碼
4. **頁面跳轉**：`window.location.href = newUrl`

### 支援的 URL 格式

```
✅ ?page=3
✅ ?page=3&category=news
✅ ?category=news&page=3
✅ ?p=5 (需要設定參數名為 "p")
✅ ?pageNum=10 (需要設定參數名為 "pageNum")
```

### 優點

- ✅ **適用範圍廣**：許多網站使用 URL 參數分頁
- ✅ **無需按鈕**：不依賴頁面元素
- ✅ **可預測**：簡單的數學運算
- ✅ **支援書籤**：URL 包含頁碼，便於分享和收藏

### 限制

- ❌ URL 必須包含頁碼參數
- ❌ 需要頁面重新載入
- ❌ 不適用於單頁應用（SPA）
- ❌ 可能繞過某些安全檢查

### 適用網站

- 論壇（如 phpBB）
- 電商網站的商品列表
- 搜尋結果頁
- 部落格文章列表

### 配置方法

1. 開啟擴充功能設定
2. 啟用「URL 參數導航」
3. 設定「URL 參數名稱」（預設為 "page"）

### 範例

```
當前 URL: https://example.com/products?page=3

按下 → 鍵：
新 URL: https://example.com/products?page=4

按下 ← 鍵：
新 URL: https://example.com/products?page=2
```

### 測試頁面

- `test/url-navigation-test.html`

### 相關文件

- [URL 參數導航指南](URL-NAVIGATION-GUIDE.md)

---

## 第 3 層：智能連結掃描

### 描述
掃描頁面中所有包含頁碼的連結，自動找到下一頁/上一頁的 URL。

### 優先級
⭐ 低（最後備用方案）

### 工作原理

1. **掃描所有連結**：使用 `querySelectorAll('a[href]')`
2. **過濾分頁連結**：找出 href 包含 page 參數的連結
3. **提取頁碼**：從每個連結的 URL 中提取頁碼
4. **推斷當前頁**：
   - 優先從當前 URL 獲取
   - 如果 URL 中沒有，從連結列表推斷
5. **查找目標連結**：找到目標頁碼對應的連結
6. **執行導航**：跳轉到該連結

### 推斷算法

```javascript
// 情況 1: URL 中有頁碼 (最準確)
URL: ?page=3
當前頁: 3

// 情況 2: 從連結推斷
連結: [?page=1, ?page=2, ?page=4, ?page=5]
缺少: 3
推斷: 當前頁 = 3

// 情況 3: 從最小頁碼推斷
連結: [?page=8, ?page=9, ?page=10]
最小: 8
推斷: 當前頁 = 8 - 1 = 7
```

### 優點

- ✅ **最大相容性**：幾乎適用於任何使用連結分頁的網站
- ✅ **自動適應**：不需要配置
- ✅ **智能推斷**：可以在 URL 中沒有頁碼時工作
- ✅ **最後保障**：前兩層都失敗時的救命稻草

### 限制

- ❌ 性能稍差（需要掃描 DOM）
- ❌ 推斷可能不準確（在特殊情況下）
- ❌ 不支援純 JavaScript 事件處理的分頁
- ❌ 依賴於連結的存在

### 適用網站

- 純連結式分頁（沒有按鈕）
- 隱藏按鈕但保留連結的網站
- 連結列表式的分頁
- 簡單的 HTML 分頁

### 配置方法

1. 開啟擴充功能設定
2. 啟用「智能連結掃描」
3. 設定「URL 參數名稱」以匹配網站使用的參數

### 範例

```html
<!-- 頁面結構 -->
<div class="pagination">
  <a href="?page=1">1</a>
  <a href="?page=2">2</a>
  <span class="current">3</span>
  <a href="?page=4">4</a>
  <a href="?page=5">5</a>
</div>

<!-- 掃描結果 -->
找到連結: [1, 2, 4, 5]
推斷當前頁: 3
按 → 鍵導航到: ?page=4
```

### 測試頁面

- `test/href-scan-test.html`

### 相關文件

- [智能連結掃描指南](HREF-SCAN-GUIDE.md)

---

## 策略對比

| 特性 | 按鈕導航 | URL 參數導航 | 智能連結掃描 |
|-----|---------|------------|------------|
| **可靠性** | ⭐⭐⭐ | ⭐⭐ | ⭐ |
| **速度** | ⭐⭐⭐ | ⭐⭐ | ⭐ |
| **相容性** | ⭐ | ⭐⭐ | ⭐⭐⭐ |
| **配置難度** | 中 | 低 | 低 |
| **需要頁面元素** | 是 | 否 | 是 |
| **需要 URL 參數** | 否 | 是 | 否 |
| **支援 AJAX** | 是 | 否 | 否 |
| **推薦使用** | 是 | 是 | 備用 |

---

## 完整導航流程圖

```
用戶按下方向鍵 (← 或 →)
          ↓
  檢查擴充功能是否啟用？
          ↓ 是
  檢查焦點是否在輸入框？
          ↓ 否
┌─────────────────────────────┐
│   第 1 層：按鈕導航           │
├─────────────────────────────┤
│ 1. 查找自訂 ID 按鈕          │
│ 2. 查找預設 ID 按鈕          │
│ 3. 查找 Class 按鈕           │
│ 4. 查找 Data 屬性按鈕        │
└─────────────────────────────┘
          ↓ 找到按鈕？
          ↓ 是
    點擊按鈕 → 完成 ✅
          ↓ 否
┌─────────────────────────────┐
│   第 2 層：URL 參數導航      │
├─────────────────────────────┤
│ 1. 檢查功能是否啟用          │
│ 2. 提取當前 URL 頁碼         │
│ 3. 計算目標頁碼              │
│ 4. 構建新 URL                │
│ 5. 導航到新 URL              │
└─────────────────────────────┘
          ↓ URL 中有頁碼？
          ↓ 是
    頁面跳轉 → 完成 ✅
          ↓ 否
┌─────────────────────────────┐
│   第 3 層：智能連結掃描      │
├─────────────────────────────┤
│ 1. 檢查功能是否啟用          │
│ 2. 掃描所有 <a> 標籤         │
│ 3. 過濾包含 page 的連結      │
│ 4. 提取頁碼                  │
│ 5. 推斷當前頁碼              │
│ 6. 查找目標頁碼的連結        │
│ 7. 導航到該連結              │
└─────────────────────────────┘
          ↓ 找到連結？
          ↓ 是
    頁面跳轉 → 完成 ✅
          ↓ 否
    所有方法失敗 ❌
```

---

## 使用建議

### 網站類型與策略選擇

#### 1. 現代化網站（推薦配置）

**特徵：**
- 使用 DataTables、Bootstrap 等框架
- 有明確的分頁按鈕
- AJAX 動態載入內容

**推薦策略：**
- ✅ 啟用按鈕導航
- ✅ 配置自訂按鈕 ID
- ⚠️ URL 參數導航可能不適用

#### 2. 傳統網站（預設配置）

**特徵：**
- 使用 URL 參數分頁（`?page=N`）
- 可能有按鈕，可能沒有
- 每次分頁都重新載入頁面

**推薦策略：**
- ✅ 啟用所有三層策略
- ✅ 確保 URL 參數名稱正確
- ✅ 保持預設配置

#### 3. 簡單網站（最小配置）

**特徵：**
- 只有連結，沒有按鈕
- URL 可能沒有頁碼參數
- 基礎 HTML 結構

**推薦策略：**
- ✅ 啟用智能連結掃描
- ✅ 配置 URL 參數名稱
- ⚠️ 按鈕導航可能無效

#### 4. 單頁應用（特殊處理）

**特徵：**
- React、Vue、Angular 等框架
- URL 可能使用 Hash 或 History API
- 分頁通過 JavaScript 處理

**推薦策略：**
- ✅ 優先使用按鈕導航
- ✅ 仔細配置按鈕 ID
- ❌ 其他策略可能不適用

---

## 性能優化

### 按鈕導航優化

- **快取機制**：找到的按鈕會被快取 5 秒
- **DOM 觀察**：使用 MutationObserver 監聽變化
- **智能更新**：只在必要時更新快取

### URL 參數導航優化

- **無需 DOM 操作**：純 URL 處理
- **即時執行**：無延遲
- **記憶體友好**：不保存任何狀態

### 智能連結掃描優化

- **選擇器優化**：使用高效的選擇器
- **提前過濾**：只處理包含關鍵字的連結
- **即時返回**：找到目標後立即停止

---

## 配置範例

### 範例 1: 完全啟用（推薦）

```json
{
  "enabled": true,
  "urlNavigation": true,
  "urlParamName": "page",
  "hrefScan": true,
  "customNextIds": [],
  "customPrevIds": []
}
```

**適用於：**大多數網站

### 範例 2: 僅按鈕導航

```json
{
  "enabled": true,
  "urlNavigation": false,
  "hrefScan": false,
  "customNextIds": ["my-next-btn"],
  "customPrevIds": ["my-prev-btn"]
}
```

**適用於：**DataTables 等有明確按鈕的網站

### 範例 3: 僅 URL 導航

```json
{
  "enabled": true,
  "urlNavigation": true,
  "urlParamName": "p",
  "hrefScan": false
}
```

**適用於：**論壇、簡單的列表頁

### 範例 4: 僅連結掃描

```json
{
  "enabled": true,
  "urlNavigation": false,
  "hrefScan": true,
  "urlParamName": "page"
}
```

**適用於：**純連結式分頁的網站

---

## 故障排除

### 問題 1: 所有導航都不工作

**檢查清單：**
1. ✅ 擴充功能是否啟用？
2. ✅ 焦點是否在輸入框中？
3. ✅ 控制台有錯誤訊息嗎？

### 問題 2: 按鈕導航不工作

**可能原因：**
- 按鈕 ID 配置錯誤
- 按鈕被 CSS 隱藏
- 按鈕被禁用

**解決方法：**
1. 打開開發者工具檢查按鈕
2. 配置正確的按鈕 ID
3. 嘗試使用其他策略

### 問題 3: URL 導航不工作

**可能原因：**
- URL 中沒有 page 參數
- 參數名稱設定錯誤
- 功能被停用

**解決方法：**
1. 檢查當前 URL 格式
2. 確認參數名稱設定
3. 啟用 URL 參數導航

### 問題 4: 連結掃描不工作

**可能原因：**
- 頁面沒有分頁連結
- 連結是 JavaScript 處理的
- 參數名稱不匹配

**解決方法：**
1. 檢查頁面 HTML 結構
2. 查看控制台日誌
3. 確認 URL 參數名稱

---

## 開發資訊

### 核心函數

```javascript
// content.js

// 第 1 層：按鈕導航
findButton(type)
clickNextButton()
clickPreviousButton()

// 第 2 層：URL 參數導航
getCurrentPageNumber()
navigateToPage(pageNumber)
navigateToNextPage()
navigateToPreviousPage()

// 第 3 層：智能連結掃描
scanPageLinks()
extractPageNumber(url)
findLinkByPageNumber(targetPage)
navigateToNextPageByHref()
navigateToPreviousPageByHref()
```

### 設定管理

```javascript
// popup.js

loadSettings()      // 載入設定
saveSettings()      // 儲存設定
notifyContentScripts()  // 通知內容腳本
```

---

## 測試指南

### 測試所有策略

1. **按鈕導航測試**
   ```
   開啟: test/test-page.html
   測試: 預設按鈕功能
   ```

2. **自訂 ID 測試**
   ```
   開啟: test/custom-id-test.html
   配置: 添加自訂 ID
   測試: 自訂按鈕功能
   ```

3. **URL 導航測試**
   ```
   開啟: test/url-navigation-test.html
   測試: URL 參數修改
   ```

4. **連結掃描測試**
   ```
   開啟: test/href-scan-test.html
   測試: 智能連結識別
   ```

### 完整測試流程

1. 啟用所有功能
2. 依次訪問每個測試頁面
3. 使用方向鍵測試
4. 檢查控制台日誌
5. 驗證導航結果

---

## 版本資訊

### v1.0.0 (2024-11-07)

**新增功能：**
- ✨ 三層智能導航策略
- ✨ 按鈕導航（預設 + 自訂 ID）
- ✨ URL 參數導航
- ✨ 智能連結掃描
- ✨ 完整的配置介面
- ✨ 四個測試頁面

---

## 相關文件

- [安裝說明](INSTALL.md)
- [自訂 ID 指南](CUSTOM-ID-GUIDE.md)
- [URL 參數導航指南](URL-NAVIGATION-GUIDE.md)
- [智能連結掃描指南](HREF-SCAN-GUIDE.md)
- [測試指南](TESTING.md)
- [相容性說明](COMPATIBILITY.md)

---

## 結語

Anime Next 的三層導航策略設計旨在提供**最大的相容性**和**最佳的使用體驗**。無論您訪問什麼類型的網站，都能享受鍵盤導航的便利。

如有任何問題或建議，歡迎回報！
